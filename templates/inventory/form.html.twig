{% extends 'base.html.twig' %}

{% set title = page_title|trans %}

{% block body %}
<div class="container-fluid py-4">
    {% include '_breadcrumb.html.twig' with {
        'item': item,
        'type': 'inventory',
        'action': (item.id) ? 'edit' : 'create'
    } %}

    <div class="row">
        <div class="col-12 col-md-8 offset-md-2 col-lg-6 offset-lg-3">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil"></i> {{ page_title|trans }}
                    </h4>
                    {% if item.id %}
                    <span class="badge bg-light text-dark">
                        ID: {{ item.id }}
                    </span>
                    {% endif %}
                </div>

                <div class="card-body">
                    {{ form_start(form, {
                        'attr': {
                            'id': 'inventoryForm',
                            'class': 'needs-validation',
                            'novalidate': 'novalidate',
                            'data-controller': 'inventory-form',
                            'data-inventory-form-target': 'form',
                            'data-inventory-form-category-specs-url-value': path('api_category_specs', {'category': '__CATEGORY__'}),
                            'data-inventory-form-current-category-value': item.category.value|default(''),
                            'data-inventory-form-current-specifications-value': item.specifications|json_encode,
                            'data-inventory-form-update-url-value': item.id ? path('api_inventory_update', {'id': item.id}) : '',
                            'data-inventory-form-create-url-value': path('api_inventory_create'),
                            'data-inventory-form-item-id-value': item.id|default(0)
                        }
                    }) }}

                    <div data-inventory-form-target="formErrors"
                        class="alert alert-danger d-none"
                        role="alert"></div>

                    <!-- Секция 1: Основная информация -->
                    <div class="form-section">
                        <h5 class="form-section-title">
                            <i class="bi bi-info-circle me-2"></i>{{ 'inventory_item.form.section_basic'|trans }}
                        </h5>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    {{ form_label(form.name, null, {
                                        'label_attr': {'class': 'form-label required-field'}
                                    }) }}
                                    {{ form_widget(form.name, {
                                        'attr': {
                                            'class': 'form-control' ~ (form_errors(form.name) ? ' is-invalid' : ''),
                                            'autofocus': 'autofocus'
                                        }
                                    }) }}
                                    {{ form_errors(form.name) }}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.category, null, {
                                        'label_attr': {'class': 'form-label required-field'}
                                    }) }}
                                    {{ form_widget(form.category, {
                                        'attr': {
                                            'class': 'form-select category-selector' ~ (form_errors(form.category) ? ' is-invalid' : ''),
                                            'data-inventory-form-target': 'categorySelector',
                                            'data-action': 'change->inventory-form#onCategoryChange'
                                        }
                                    }) }}
                                    {{ form_errors(form.category) }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.inventoryNumber, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    {{ form_widget(form.inventoryNumber, {
                                        'attr': {
                                            'class': 'form-control' ~ (form_errors(form.inventoryNumber) ? ' is-invalid' : ''),
                                            'data-inventory-form-target': 'inventoryNumberField'
                                        }
                                    }) }}
                                    {{ form_errors(form.inventoryNumber) }}
                                    <div class="form-text">{{ 'inventory_item.form.inventory_number_help'|trans }}</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.serialNumber, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    {{ form_widget(form.serialNumber, {
                                        'attr': {
                                            'class': 'form-control' ~ (form_errors(form.serialNumber) ? ' is-invalid' : ''),
                                        }
                                    }) }}
                                    {{ form_errors(form.serialNumber) }}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    {{ form_label(form.description, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    {{ form_widget(form.description, {
                                        'attr': {
                                            'class': 'form-control' ~ (form_errors(form.description) ? ' is-invalid' : ''),
                                            'rows': 3
                                        }
                                    }) }}
                                    {{ form_errors(form.description) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Секция 2: Статус и классификация -->
                    <div class="form-section">
                        <h5 class="form-section-title">
                            <i class="bi bi-tags me-2"></i>{{ 'inventory_item.form.section_classification'|trans }}
                        </h5>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.balanceType, null, {
                                        'label_attr': {'class': 'form-label required-field'}
                                    }) }}
                                    {{ form_widget(form.balanceType, {
                                        'attr': {
                                            'class': 'form-select balance-type-selector' ~ (form_errors(form.balanceType) ? ' is-invalid' : ''),
                                            'data-action': 'change->inventory-form#onBalanceTypeChange',
                                            'data-inventory-form-target': 'balanceTypeSelector'
                                        }
                                    }) }}
                                    {{ form_errors(form.balanceType) }}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.status, null, {
                                        'label_attr': {'class': 'form-label required-field'}
                                    }) }}
                                    {{ form_widget(form.status, {
                                        'attr': {
                                            'class': 'form-select' ~ (form_errors(form.status) ? ' is-invalid' : '')
                                        }
                                    }) }}
                                    {{ form_errors(form.status) }}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.type, null, {
                                        'label_attr': {'class': 'form-label required-field'}
                                    }) }}
                                    {{ form_widget(form.type, {
                                        'attr': {
                                            'class': 'form-select' ~ (form_errors(form.type) ? ' is-invalid' : '')
                                        }
                                    }) }}
                                    {{ form_errors(form.type) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Секция 3: Финансовая информация -->
                    <div class="form-section">
                        <h5 class="form-section-title">
                            <i class="bi bi-cash-coin me-2"></i>{{ 'inventory_item.form.section_financial'|trans }}
                        </h5>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.purchasePrice, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    <div class="input-group money-input-group">
                                        {{ form_widget(form.purchasePrice, {
                                            'attr': {
                                                'class': 'form-control' ~ (form_errors(form.purchasePrice) ? ' is-invalid' : ''),
                                                'placeholder': '0.00',
                                                'inputmode': 'decimal'
                                            }
                                        }) }}
                                        <span class="input-group-text">₽</span>
                                    </div>
                                    {{ form_errors(form.purchasePrice) }}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.purchaseDate, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    {{ form_widget(form.purchaseDate, {
                                        'attr': {
                                            'class': 'form-control datepicker-input' ~ (form_errors(form.purchaseDate) ? ' is-invalid' : '')
                                        }
                                    }) }}
                                    {{ form_errors(form.purchaseDate) }}
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form_label(form.commissioningDate, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    {{ form_widget(form.commissioningDate, {
                                        'attr': {
                                            'class': 'form-control datepicker-input' ~ (form_errors(form.commissioningDate) ? ' is-invalid' : '')
                                        }
                                    }) }}
                                    {{ form_errors(form.commissioningDate) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Секция 4: Ответственность и местоположение -->
                    <div class="form-section">
                        <h5 class="form-section-title">
                            <i class="bi bi-geo-alt me-2"></i>{{ 'inventory_item.form.section_location'|trans }}
                        </h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.location, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    <div class="input-group">
                                        {{ form_widget(form.location, {
                                            'attr': {
                                                'class': 'form-select location-selector' ~ (form_errors(form.location) ? ' is-invalid' : '')
                                            }
                                        }) }}
                                        <a href="{{ path('app_location_new') }}"
                                           class="btn btn-outline-secondary"
                                           target="_blank"
                                           title="{{ 'inventory_item.form.add_location'|trans }}"
                                           data-bs-toggle="tooltip">
                                            <i class="bi bi-plus-lg"></i>
                                        </a>
                                    </div>
                                    {{ form_errors(form.location) }}
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form_label(form.responsiblePerson, null, {
                                        'label_attr': {'class': 'form-label'}
                                    }) }}
                                    {{ form_widget(form.responsiblePerson, {
                                        'attr': {
                                            'class': 'form-control' ~ (form_errors(form.responsiblePerson) ? ' is-invalid' : ''),
                                            'placeholder': 'Иванов И.И.'
                                        }
                                    }) }}
                                    {{ form_errors(form.responsiblePerson) }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Секция 5: Спецификации (динамическая) -->
                    <div class="form-section" id="specificationsSection"
                         data-inventory-form-target="specificationsSection">
                        <h5 class="form-section-title">
                            <i class="bi bi-gear me-2"></i>{{ 'inventory_item.form.section_specifications'|trans }}
                        </h5>

                        <div class="alert alert-info" role="alert" id="noSpecsAlert">
                            <i class="bi bi-info-circle"></i>
                            {{ 'inventory_item.form.no_specifications_required'|trans }}
                        </div>

                        <div id="specificationsForm" class="d-none">
                            {% if item.category.hasSpecifications %}
                                {% include 'inventory/_specifications_form.html.twig' with {
                                    'category': item.category,
                                    'specifications': item.specifications
                                } %}
                            {% endif %}
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <div>
                            {% if item.id %}
                            <a href="{{ path('app_inventory_show', {'id': item.id}) }}"
                               class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> {{ 'form.cancel'|trans }}
                            </a>
                            <!-- Кнопка удаления с подтверждением -->
                            <button type="button"
                                    class="btn btn-outline-danger ms-2"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal">
                                <i class="bi bi-trash"></i> {{ 'form.delete'|trans }}
                            </button>
                            {% else %}
                            <a href="{{ path('app_inventory_index') }}"
                               class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> {{ 'form.cancel'|trans }}
                            </a>
                            {% endif %}
                        </div>
                        <div>
                            <button type="submit"
                                    class="btn btn-primary"
                                    data-inventory-form-target="submitButton"
                                    data-action="inventory-form#submitForm">
                                <i class="bi bi-check-circle"></i> {{ 'form.submit'|trans }}
                            </button>
                        </div>
                    </div>

                    {{ form_end(form) }}
                </div>
            </div>

            <!-- Информация об объекте -->
            {% if item.id %}
            <div class="card shadow mt-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> {{ 'inventory_item.info.title'|trans }}
                    </h5>
                    <span class="badge {{ item.category.badgeClass }}">
                        <i class="bi {{ item.category.icon }}"></i> {{ ('inventory_item.category.' ~ item.category.value)|trans }}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row small">
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%">ID:</th>
                                    <td>{{ item.id }}</td>
                                </tr>
                                <tr>
                                    <th>{{ 'inventory_item.info.created_at'|trans }}:</th>
                                    <td>{{ item.createdAt|date('d.m.Y H:i') }}</td>
                                </tr>
                                <tr>
                                    <th>{{ 'inventory_item.info.updated_at'|trans }}:</th>
                                    <td>{{ item.updatedAt|date('d.m.Y H:i') }}</td>
                                </tr>
                                <tr>
                                    <th>{{ 'inventory_item.info.type'|trans }}:</th>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ ('inventory_item.type.' ~ item.type.value)|trans }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>{{ 'inventory_item.info.status'|trans }}:</th>
                                    <td>
                                        {% if item.status.value == 'new' %}
                                            <span class="badge bg-success">
                                        {% elseif item.status.value == 'in_use' %}
                                            <span class="badge bg-primary">
                                        {% elseif item.status.value == 'under_repair' %}
                                            <span class="badge bg-warning">
                                        {% elseif item.status.value == 'written_off' %}
                                            <span class="badge bg-danger">
                                        {% else %}
                                            <span class="badge bg-secondary">
                                        {% endif %}
                                        {{ ('inventory_item.status.' ~ item.status.value)|trans }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%">{{ 'inventory_item.info.movements'|trans }}:</th>
                                    <td>{{ item.movementLogs|length }}</td>
                                </tr>
                                {% if item.location %}
                                <tr>
                                    <th>{{ 'inventory_item.info.current_location'|trans }}:</th>
                                    <td>
                                        <span class="badge bg-info">
                                            <i class="bi bi-geo-alt"></i> {{ item.location.name }}
                                        </span>
                                        {% if item.location.roomNumber %}
                                            <br><small>{{ 'inventory_item.info.room'|trans }}: {{ item.location.roomNumber }}</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                                {% if item.responsiblePerson %}
                                <tr>
                                    <th>{{ 'inventory_item.info.responsible_person'|trans }}:</th>
                                    <td>{{ item.responsiblePerson }}</td>
                                </tr>
                                {% endif %}
                                {% if item.purchasePrice %}
                                <tr>
                                    <th>{{ 'inventory_item.info.purchase_price'|trans }}:</th>
                                    <td>{{ item.purchasePrice|number_format(2, '.', ' ') }} ₽</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    <!-- Существующие спецификации -->
                    {% if item.specifications is not empty %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="mb-2">{{ 'inventory_item.info.current_specifications'|trans }}</h6>
                        <div class="row">
                            {% for key, value in item.specifications %}
                            <div class="col-md-6 mb-2">
                                <span class="specification-key">{{ key|trans }}:</span>
                                <span class="specification-value">{{ value }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Подсказки -->
            <div class="card shadow mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb"></i> {{ 'inventory_item.tips.title'|trans }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle text-success"></i> {{ 'inventory_item.tips.do_title'|trans }}</h6>
                            <ul class="small">
                                <li>{{ 'inventory_item.tips.do_unique_inventory_number'|trans }}</li>
                                <li>{{ 'inventory_item.tips.do_fill_all_pc_specs'|trans }}</li>
                                <li>{{ 'inventory_item.tips.do_serial_number_if_available'|trans }}</li>
                                <li>{{ 'inventory_item.tips.do_describe_condition'|trans }}</li>
                                <li>{{ 'inventory_item.tips.do_specific_names'|trans }}</li>
                                <li>{{ 'inventory_item.tips.do_actual_location'|trans }}</li>
                                <li>{{ 'inventory_item.tips.do_complete_specifications'|trans }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-exclamation-triangle text-warning"></i> {{ 'inventory_item.tips.dont_title'|trans }}</h6>
                            <ul class="small">
                                <li>{{ 'inventory_item.tips.dont_duplicate_inventory_numbers'|trans }}</li>
                                <li>{{ 'inventory_item.tips.dont_abbreviations_in_name'|trans }}</li>
                                <li>{{ 'inventory_item.tips.dont_incomplete_description'|trans }}</li>
                                <li>{{ 'inventory_item.tips.dont_inaccurate_location'|trans }}</li>
                                <li>{{ 'inventory_item.tips.dont_generic_names'|trans }}</li>
                                <li>{{ 'inventory_item.tips.dont_leaving_required_fields_empty'|trans }}</li>
                                <li>{{ 'inventory_item.tips.dont_outdated_information'|trans }}</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Дополнительная информация -->
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="mb-2"><i class="bi bi-info-circle text-primary"></i> {{ 'inventory_item.tips.additional_recommendations'|trans }}</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-primary mb-2">
                                    <div class="card-body py-2">
                                        <small>
                                            <i class="bi bi-calendar-check text-primary"></i>
                                            <strong>{{ 'inventory_item.tips.relevance'|trans }}:</strong> {{ 'inventory_item.tips.relevance_desc'|trans }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success mb-2">
                                    <div class="card-body py-2">
                                        <small>
                                            <i class="bi bi-shield-check text-success"></i>
                                            <strong>{{ 'inventory_item.tips.security'|trans }}:</strong> {{ 'inventory_item.tips.security_desc'|trans }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info mb-2">
                                    <div class="card-body py-2">
                                        <small>
                                            <i class="bi bi-arrows-move text-info"></i>
                                            <strong>{{ 'inventory_item.tips.movements'|trans }}:</strong> {{ 'inventory_item.tips.movements_desc'|trans }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if item.id %}
{% include 'modal/_inventor_delete.html.twig' %}
{% endif %}

{% include 'modal/_success.html.twig' %}

{% endblock %}
